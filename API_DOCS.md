# üåê API –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø (–ù–æ–≤–∞—è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)

## –û–±–∑–æ—Ä

FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º **–Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã**:
```
LLM –ø–∞—Ä—Å–µ—Ä ‚Üí –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ ‚Üí –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ ‚Üí –û—Ç–≤–µ—Ç
```

## –ó–∞–ø—É—Å–∫ API

```bash
# –ó–∞–ø—É—Å–∫ —Å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π
uvicorn src.api.main:app --reload

# –ó–∞–ø—É—Å–∫ –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º –ø–æ—Ä—Ç—É
uvicorn src.api.main:app --host 0.0.0.0 --port 8000
```

API –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞: `http://localhost:8000`

## –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã

### 1. –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
```
GET /
```
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTML –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API

### 2. API –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
```
GET /api
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "message": "RAG –ü–æ–∏—Å–∫ –ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö API",
  "version": "1.0.0",
  "docs": "/docs",
  "health": "/health"
}
```

### 3. Health Check
```
GET /health
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "status": "healthy",
  "models_loaded": true,
  "products_count": 98,
  "embedding_model": "intfloat/multilingual-e5-small",
  "llm_available": true
}
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `status`: "healthy" –∏–ª–∏ "unhealthy"
- `models_loaded`: –∑–∞–≥—Ä—É–∂–µ–Ω—ã –ª–∏ –º–æ–¥–µ–ª–∏
- `products_count`: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –ë–î
- `embedding_model`: –º–æ–¥–µ–ª—å –¥–ª—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
- `llm_available`: –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ LLM –ø–∞—Ä—Å–µ—Ä

### 4. –ü–æ–∏—Å–∫ (POST)
```
POST /search
```

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "query": "–ö–æ–º–ø–ª–µ–∫—Ç –¥–ª—è –º–æ–Ω—Ç–∞–∂–∞: –∫–æ—Ä–æ–± 200x200, –∫—Ä—ã—à–∫–∞, 4 –≤–∏–Ω—Ç–∞ –ú6",
  "top_k": 3,
  "use_llm": true
}
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `query` (string, required): –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
- `top_k` (int, optional): –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞ –∫–∞–∂–¥—ã–π —Ç–æ–≤–∞—Ä (1-10, default: 3)
- `use_llm` (bool, optional): –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å LLM –ø–∞—Ä—Å–µ—Ä (default: true)

**–û—Ç–≤–µ—Ç:**
```json
{
  "query_id": null,
  "original_query": "–ö–æ–º–ø–ª–µ–∫—Ç –¥–ª—è –º–æ–Ω—Ç–∞–∂–∞: –∫–æ—Ä–æ–± 200x200, –∫—Ä—ã—à–∫–∞, 4 –≤–∏–Ω—Ç–∞ –ú6",
  "items": [
    {
      "requested_item": "–ö–æ—Ä–æ–± 200x200",
      "quantity": 1,
      "found_product": {
        "id": 3,
        "name": "–ö–æ—Ä–æ–± 200x200 –º–º, L=2000 –º–º, –≥–æ—Ä—è—á–µ–µ —Ü–∏–Ω–∫–æ–≤–∞–Ω–∏–µ...",
        "cost": 88498.0,
        "category": "–ö–æ—Ä–æ–±"
      },
      "relevance_score": 0.9847,
      "unit_price": 88498.0,
      "total_price": 88498.0,
      "specifications": "200x200 –º–º",
      "alternatives": [...]
    },
    {
      "requested_item": "–ö—Ä—ã—à–∫–∞ 200",
      "quantity": 1,
      "found_product": {...},
      "unit_price": 45131.0,
      "total_price": 45131.0,
      ...
    },
    {
      "requested_item": "–í–∏–Ω—Ç –ú6",
      "quantity": 4,
      "found_product": {...},
      "unit_price": 19047.0,
      "total_price": 76188.0,
      ...
    }
  ],
  "total_items": 3,
  "found_items": 3,
  "total_cost": 209817.0,
  "currency": "RUB"
}
```

### 5. –ü–æ–∏—Å–∫ (GET)
```
GET /search?q=–∫–æ—Ä–æ–±+200x200&top_k=3&use_llm=true
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `q` (string, required): –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
- `top_k` (int, optional): –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞ —Ç–æ–≤–∞—Ä (default: 3)
- `use_llm` (bool, optional): –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å LLM (default: true)

**–ü—Ä–∏–º–µ—Ä:**
```
GET /search?q=–ö–æ–º–ø–ª–µ–∫—Ç:%20–∫–æ—Ä–æ–±%20200x200,%20–∫—Ä—ã—à–∫–∞,%20–≤–∏–Ω—Ç—ã
```

### 6. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤
```
GET /products/count
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "count": 98
}
```

### 7. –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤
```
GET /products/categories
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "categories": [
    "–ë–æ–ª—Ç",
    "–í–∏–Ω—Ç",
    "–ì–∞–π–∫–∞",
    "–ö–æ—Ä–æ–±",
    "–ö—Ä—ã—à–∫–∞",
    ...
  ],
  "count": 25
}
```

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### cURL

**–ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å:**
```bash
curl -X GET "http://localhost:8000/search?q=–ì–∞–π–∫–∞%20–ú6&top_k=3"
```

**–ö–æ–º–ø–ª–µ–∫—Ç:**
```bash
curl -X POST "http://localhost:8000/search" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "–ö–æ–º–ø–ª–µ–∫—Ç: –∫–æ—Ä–æ–± 200x200, –∫—Ä—ã—à–∫–∞, 4 –≤–∏–Ω—Ç–∞ –ú6, 4 –≥–∞–π–∫–∏ –ú6",
    "top_k": 3,
    "use_llm": true
  }'
```

### Python (requests)

```python
import requests

# –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å
response = requests.get(
    "http://localhost:8000/search",
    params={"q": "–ö–æ—Ä–æ–± 200x200", "top_k": 3}
)
result = response.json()
print(f"–ù–∞–π–¥–µ–Ω–æ: {result['found_items']} —Ç–æ–≤–∞—Ä–æ–≤")
print(f"–ò—Ç–æ–≥–æ: {result['total_cost']:,} —Ä—É–±.")

# –ö–æ–º–ø–ª–µ–∫—Ç (POST)
response = requests.post(
    "http://localhost:8000/search",
    json={
        "query": "–ö–æ–º–ø–ª–µ–∫—Ç –¥–ª—è –º–æ–Ω—Ç–∞–∂–∞: –∫–æ—Ä–æ–±, –∫—Ä—ã—à–∫–∞, –≤–∏–Ω—Ç—ã",
        "top_k": 3,
        "use_llm": True
    }
)
result = response.json()

for item in result['items']:
    print(f"{item['requested_item']}: {item['quantity']} —à—Ç. √ó {item['unit_price']:,} = {item['total_price']:,} —Ä—É–±.")
```

### JavaScript (fetch)

```javascript
// GET –∑–∞–ø—Ä–æ—Å
fetch('http://localhost:8000/search?q=–ö–æ—Ä–æ–±%20200x200&top_k=3')
  .then(response => response.json())
  .then(data => {
    console.log('–ù–∞–π–¥–µ–Ω–æ:', data.found_items, '—Ç–æ–≤–∞—Ä–æ–≤');
    console.log('–°—Ç–æ–∏–º–æ—Å—Ç—å:', data.total_cost, data.currency);
  });

// POST –∑–∞–ø—Ä–æ—Å
fetch('http://localhost:8000/search', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    query: '–ö–æ–º–ø–ª–µ–∫—Ç: –∫–æ—Ä–æ–± 200x200, –∫—Ä—ã—à–∫–∞, –≤–∏–Ω—Ç—ã',
    top_k: 3,
    use_llm: true
  })
})
  .then(response => response.json())
  .then(data => {
    data.items.forEach(item => {
      console.log(`${item.requested_item}: ${item.quantity} —à—Ç.`);
      console.log(`  ‚Üí ${item.found_product?.name}`);
      console.log(`  üí∞ ${item.total_price} —Ä—É–±.`);
    });
  });
```

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### 1. LLM –ø–∞—Ä—Å–∏–Ω–≥ –Ω–∞ –≤—Ö–æ–¥–µ
- LLM **—Å—Ä–∞–∑—É** —Ä–∞–∑–±–∏—Ä–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ + –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
- –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (CUDA > MPS > CPU)
- –¢–æ—á–Ω–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞: ~95%

### 2. –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
–ö–∞–∂–¥—ã–π —Ç–æ–≤–∞—Ä –≤ –æ—Ç–≤–µ—Ç–µ —Å–æ–¥–µ—Ä–∂–∏—Ç:
- `requested_item`: —á—Ç–æ –∑–∞–ø—Ä–æ—Å–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- `quantity`: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ LLM)
- `found_product`: –Ω–∞–π–¥–µ–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
- `unit_price`: —Ü–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É
- `total_price`: –∏—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (quantity √ó unit_price)
- `alternatives`: –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏
API –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—á–∏—Ç–∞–µ—Ç:
- –°—Ç–æ–∏–º–æ—Å—Ç—å –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ √ó —Ü–µ–Ω–∞)
- –û–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—Å–µ–≥–æ –∫–æ–º–ø–ª–µ–∫—Ç–∞

## –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

Swagger UI –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞: **http://localhost:8000/docs**

![Swagger UI](https://fastapi.tiangolo.com/img/index/index-01-swagger-ui-simple.png)

–ó–¥–µ—Å—å –º–æ–∂–Ω–æ:
- üìñ –ò–∑—É—á–∏—Ç—å –≤—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
- üß™ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- üìã –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—Ç–≤–µ—Ç–æ–≤

## –ö–æ–¥—ã –æ—à–∏–±–æ–∫

| –ö–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|----------|
| 200 | –£—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—Ä–æ—Å |
| 400 | –ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ |
| 500 | –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞ |
| 503 | –°–∏—Å—Ç–µ–º–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ |

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ (—Å—Ä–µ–¥–Ω–µ–µ)

| –ó–∞–ø—Ä–æ—Å | LLM (GPU) | LLM (CPU) | Fallback |
|--------|-----------|-----------|----------|
| –ü—Ä–æ—Å—Ç–æ–π (1 —Ç–æ–≤–∞—Ä) | ~5s | ~60s | ~0.5s |
| –°—Ä–µ–¥–Ω–∏–π (2-3 —Ç–æ–≤–∞—Ä–∞) | ~8s | ~80s | ~1s |
| –°–ª–æ–∂–Ω—ã–π (4+ —Ç–æ–≤–∞—Ä–∞) | ~12s | ~120s | ~2s |

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- ‚úÖ –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞: GPU (CUDA/MPS)
- ‚ö° –î–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤: `use_llm=false` (fallback)
- üîß –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏: CPU (–º–µ–¥–ª–µ–Ω–Ω–æ, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç)

## CORS

API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç CORS –¥–ª—è –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (`allow_origins=["*"]`).

–î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å:
```python
allow_origins=["https://your-frontend.com"]
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∑–¥–æ—Ä–æ–≤—å–µ —Å–∏—Å—Ç–µ–º—ã —á–µ—Ä–µ–∑ `/health`:
```bash
curl http://localhost:8000/health
```

–ï—Å–ª–∏ `llm_available=false` ‚Üí LLM –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ (–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–∞–º—è—Ç–∏)

## –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ —Å—Ç–∞—Ä–æ–≥–æ API

### –ë—ã–ª–æ (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç)
```json
{
  "query": "–ì–∞–π–∫–∞ –ú6",
  "top_k": 10,
  "use_decomposition": true,
  "complexity": "simple"
}
```

### –°—Ç–∞–ª–æ (–Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç)
```json
{
  "query": "–ö–æ–º–ø–ª–µ–∫—Ç: –∫–æ—Ä–æ–± 200x200, –∫—Ä—ã—à–∫–∞, 4 –≤–∏–Ω—Ç–∞ –ú6",
  "top_k": 3,
  "use_llm": true
}
```

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ—Ç–≤–µ—Ç–µ
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ `quantity` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ `total_price` = unit_price √ó quantity
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–∂–¥–æ–º —Ç–æ–≤–∞—Ä–µ
- ‚úÖ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
- ‚úÖ –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ —á–∏—Å–ª–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (float)
