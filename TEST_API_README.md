# Скрипты для тестирования API

Этот набор скриптов предназначен для автоматического тестирования API поиска комплектующих через файлы запросов.

## Файлы

### 1. `test_api_simple.py` (рекомендуется)
Упрощенный скрипт без зависимости от colorama - работает везде.

**Зависимости:**
- `requests`

**Запуск:**
```bash
python test_api_simple.py
```

### 2. `test_api_queries.py`
Расширенный скрипт с цветным выводом и детальной статистикой.

**Зависимости:**
- `requests`
- `colorama`

**Запуск:**
```bash
python test_api_queries.py
```

## Установка зависимостей

```bash
pip install requests colorama
```

Или через requirements.txt:
```bash
pip install -r requirements.txt
```

## Тестируемые файлы

Скрипты автоматически тестируют следующие файлы запросов:

1. `query_1_simple.json` - Простой запрос: "Крышка 200 мм"
2. `query_2_simple.json` - Простой запрос: "Гайка М6"
3. `query_4_medium.json` - Средний запрос: "Короб 100x100 мм любой длины"
4. `query_5_medium.json` - Средний запрос: "Крышка углового лотка 800мм"
5. `query_8_complex.json` - Сложный запрос: "Комплект для монтажа короба 200x200"

## Как использовать

### Шаг 1: Запустите API сервер

В одном терминале:
```bash
uvicorn src.api.main:app --reload
```

Подождите, пока сервер полностью загрузится (должно появиться сообщение "✅ RAG API готов к работе!").

### Шаг 2: Запустите тесты

В другом терминале:
```bash
python test_api_simple.py
```

## Что делают скрипты

1. **Проверка доступности API** - скрипт сначала проверяет, что API запущен и работает
2. **Загрузка файлов запросов** - читает JSON файлы с запросами
3. **Выполнение поиска** - отправляет запросы в API через POST /search
4. **Вывод результатов** - показывает найденные товары, цены и релевантность
5. **Сравнение с ожидаемыми результатами** - проверяет соответствие ожидаемым результатам
6. **Статистика** - выводит итоговую статистику по времени выполнения и точности
7. **Сохранение результатов** - сохраняет все результаты в `api_test_results.json`

## Пример вывода

```
======================================================================
  ТЕСТИРОВАНИЕ API ПОИСКА КОМПЛЕКТУЮЩИХ
======================================================================

Проверка доступности API...
✓ API доступен
  Статус: healthy
  Модели загружены: True
  Продуктов в базе: 50
  Модель эмбеддингов: intfloat/multilingual-e5-small
  LLM доступен: True

Будут протестированы следующие файлы:
  1. query_1_simple.json
  2. query_2_simple.json
  ...

======================================================================
Тестирование: query_1_simple.json
======================================================================
ID запроса: 1
Сложность: simple
Запрос: Крышка 200 мм

Выполняем поиск...
✓ Поиск выполнен за 2.45 сек

Результаты поиска:
  Всего товаров в запросе: 1
  Найдено товаров: 1
  Общая стоимость: 45131.00 RUB

Найденные товары:
[1] Крышка
    Количество: 1 шт.
    Найдено: Крышка 200 мм, L=2000 мм...
    Цена за ед.: 45131.00 руб.
    Итого: 45131.00 руб.
    Релевантность: 0.9234
...
```

## Результаты

После выполнения создается файл `api_test_results.json` с подробными результатами всех тестов, включая:

- Исходные запросы
- Найденные товары
- Время выполнения
- Сравнение с ожидаемыми результатами
- Ошибки (если были)

## Конфигурация

Вы можете изменить настройки в начале файлов скриптов:

```python
# URL API
API_BASE_URL = "http://localhost:8000"

# Список тестируемых файлов
QUERY_FILES = [
    "query_1_simple.json",
    "query_2_simple.json",
    ...
]
```

## Возможные проблемы

### API недоступен
```
✗ Не удалось подключиться к API на http://localhost:8000
```
**Решение:** Убедитесь, что API сервер запущен.

### Файл не найден
```
✗ Ошибка: Файл query_X.json не найден
```
**Решение:** Убедитесь, что все файлы запросов находятся в корневой директории проекта.

### HTTP 503 ошибка
```
✗ HTTP ошибка: 503 Service Unavailable
```
**Решение:** API еще загружается. Подождите несколько секунд и попробуйте снова.

## Дополнительные возможности

### Тестирование отдельного файла

Вы можете модифицировать скрипт для тестирования конкретного файла:

```python
# В функции main() замените:
for filename in QUERY_FILES:
# на:
for filename in ["query_1_simple.json"]:
```

### Изменение параметров поиска

В функции `search_via_api()` можно изменить параметры:

```python
payload = {
    "query": query,
    "top_k": 5,  # Количество результатов
    "use_llm": True  # Использовать LLM парсер
}
```

## Лицензия

MIT
