# üéØ –ù–û–í–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê: LLM ‚Üí –ü–û–ò–°–ö ‚Üí –û–¢–í–ï–¢

## –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
24 –æ–∫—Ç—è–±—Ä—è 2025

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è
```
–ó–∞–ø—Ä–æ—Å ‚Üí Query Enhancer ‚Üí –ü–æ–∏—Å–∫ ‚Üí LLM Validator ‚Üí –û—Ç–≤–µ—Ç
```

### –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è ‚úÖ
```
–ó–∞–ø—Ä–æ—Å ‚Üí LLM Parser ‚Üí –ü–æ–∏—Å–∫ ‚Üí –†–∞—Å—á–µ—Ç ‚Üí –û—Ç–≤–µ—Ç
```

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. LLM Request Parser (–≤—Ö–æ–¥)

**–§–∞–π–ª:** `src/llm_request_parser.py`

**–ó–∞–¥–∞—á–∞:** –†–∞–∑–±–∏—Ä–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤—ã–¥–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º

**–í—Ö–æ–¥:**
```
"–ö–æ–º–ø–ª–µ–∫—Ç –¥–ª—è –º–æ–Ω—Ç–∞–∂–∞ –∫–æ—Ä–æ–±–∞: –∫–æ—Ä–æ–± 200x200, –∫—Ä—ã—à–∫–∞, 4 –≤–∏–Ω—Ç–∞ –ú6"
```

**–í—ã—Ö–æ–¥:**
```json
{
  "items": [
    {"name": "–ö–æ—Ä–æ–± 200x200", "quantity": 1, "specifications": "200x200 –º–º"},
    {"name": "–ö—Ä—ã—à–∫–∞ 200", "quantity": 1, "specifications": "200 –º–º"},
    {"name": "–í–∏–Ω—Ç –ú6", "quantity": 4, "specifications": "–ú6"}
  ],
  "confidence": 0.9,
  "analysis": "–ö–æ–º–ø–ª–µ–∫—Ç –¥–ª—è –º–æ–Ω—Ç–∞–∂–∞ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º"
}
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (CUDA > MPS > CPU)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Qwen3-4B-Instruct
- ‚úÖ –¢–æ—á–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
- ‚úÖ Fallback –Ω–∞ —ç–≤—Ä–∏—Å—Ç–∏–∫–∏ –µ—Å–ª–∏ LLM –Ω–µ —Å–ø—Ä–∞–≤–∏–ª–∞—Å—å

**–ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:**
```python
def _detect_device(self, device: Optional[str] = None) -> str:
    if device:
        return device
    
    # CUDA (NVIDIA GPU)
    if torch.cuda.is_available():
        return "cuda"
    
    # MPS (Apple Silicon GPU)
    if hasattr(torch.backends, 'mps') and torch.backends.mps.is_available():
        return "mps"
    
    # CPU fallback
    return "cpu"
```

### 2. Hybrid Query Processor (–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä)

**–§–∞–π–ª:** `src/hybrid_processor.py`

**–ó–∞–¥–∞—á–∞:** –£–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞

**Pipeline:**

#### –®–∞–≥ 1: LLM –ø–∞—Ä—Å–∏–Ω–≥
```python
parsed_request = self.request_parser.parse_request(query)
items_to_search = parsed_request.get('items', [])
# [{"name": "–ö–æ—Ä–æ–± 200x200", "quantity": 1}, ...]
```

#### –®–∞–≥ 2: –ü–æ–∏—Å–∫ –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
```python
for item_spec in items_to_search:
    search_results = self.search_engine.search(item_spec['name'], top_k=5)
    best_product, best_score = search_results[0]
    
    unit_price = best_product.get('cost', 0)
    item_total = unit_price * quantity
    total_cost += item_total
```

#### –®–∞–≥ 3: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
```python
response = {
    "items": [
        {
            "requested_item": "–ö–æ—Ä–æ–± 200x200",
            "quantity": 1,
            "found_product": {...},
            "unit_price": 88498,
            "total_price": 88498,
            "alternatives": [...]
        }
    ],
    "total_cost": 200000,
    "currency": "RUB"
}
```

### 3. Fallback —Ä–µ–∂–∏–º (–±–µ–∑ LLM)

–ï—Å–ª–∏ `use_llm_parser=False`, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `QueryEnhancer`:

```python
processor = HybridQueryProcessor(
    search_engine=search_engine,
    use_llm_parser=False,  # –ë—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º
    use_fallback_enhancement=True
)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ fallback:**
- ‚ö° –û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ (~0.5s)
- üîß –ù–µ —Ç—Ä–µ–±—É–µ—Ç GPU
- üìä –¢–æ—á–Ω–æ—Å—Ç—å ~70%

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä

```python
from src.data_loader import DataLoader
from src.search_engine import VectorSearchEngine
from src.hybrid_processor import HybridQueryProcessor

# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
data_loader = DataLoader()
products = data_loader.get_products()

# –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫
search_engine = VectorSearchEngine(
    model_name="intfloat/multilingual-e5-small",
    index_dir="data/index_e5"
)
search_engine.build_index(products)

# –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä —Å LLM
processor = HybridQueryProcessor(
    search_engine=search_engine,
    use_llm_parser=True,  # –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ CUDA/MPS/CPU
    use_fallback_enhancement=True
)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
result = processor.process_query(
    query="–ö–æ–º–ø–ª–µ–∫—Ç: –∫–æ—Ä–æ–± 200x200, –∫—Ä—ã—à–∫–∞, 4 –≤–∏–Ω—Ç–∞ –ú6",
    top_k=3
)

print(f"–ò—Ç–æ–≥–æ: {result['total_cost']:,} —Ä—É–±.")
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–°–∫—Ä–∏–ø—Ç:** `test_new_architecture.py`

```bash
python test_new_architecture.py
```

**–¢–µ—Å—Ç—ã:**
1. –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å: "–ö–æ—Ä–æ–± 200x200"
2. –ö–æ–º–ø–ª–µ–∫—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º: "–ö–æ–º–ø–ª–µ–∫—Ç: –∫–æ—Ä–æ–±, –∫—Ä—ã—à–∫–∞, 4 –≤–∏–Ω—Ç–∞, 4 –≥–∞–π–∫–∏"
3. –ù–∞–±–æ—Ä –±–µ–∑ —Ç–æ—á–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞: "–õ–æ—Ç–æ–∫ —Å –∫—Ä—ã—à–∫–æ–π –∏ –∫—Ä–µ–ø–µ–∂–æ–º"

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –° LLM (GPU)

**Apple Silicon (MPS):**
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: ~20-30s
- –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–∞: ~5-10s
- –ü–æ–∏—Å–∫ + —Ä–∞—Å—á–µ—Ç: ~1s
- **–í—Å–µ–≥–æ: ~10-15s –Ω–∞ –∑–∞–ø—Ä–æ—Å**

**NVIDIA CUDA:**
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: ~15-20s
- –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–∞: ~2-5s
- –ü–æ–∏—Å–∫ + —Ä–∞—Å—á–µ—Ç: ~1s
- **–í—Å–µ–≥–æ: ~5-10s –Ω–∞ –∑–∞–ø—Ä–æ—Å**

**CPU:**
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: ~60s
- –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–∞: ~60s+
- –ü–æ–∏—Å–∫ + —Ä–∞—Å—á–µ—Ç: ~1s
- **–í—Å–µ–≥–æ: ~60s+ –Ω–∞ –∑–∞–ø—Ä–æ—Å**

### –ë–µ–∑ LLM (Fallback)

**–õ—é–±–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:**
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: ~2s
- –ü–∞—Ä—Å–∏–Ω–≥ (—ç–≤—Ä–∏—Å—Ç–∏–∫–∏): <0.1s
- –ü–æ–∏—Å–∫ + —Ä–∞—Å—á–µ—Ç: ~0.5s
- **–í—Å–µ–≥–æ: ~0.5s –Ω–∞ –∑–∞–ø—Ä–æ—Å**

## –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –°—Ç–∞—Ä–∞—è | –ù–æ–≤–∞—è |
|----------|--------|-------|
| **–¢–æ—á–Ω–æ—Å—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞** | ~70% | ~95% |
| **–°–∫–æ—Ä–æ—Å—Ç—å (GPU)** | ~60s | ~10s |
| **–°–∫–æ—Ä–æ—Å—Ç—å (CPU)** | ~120s | ~60s |
| **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ MPS** | ‚ùå | ‚úÖ |
| **Fallback —Ä–µ–∂–∏–º** | ‚úÖ | ‚úÖ |
| **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å** | –°—Ä–µ–¥–Ω—è—è | –í—ã—Å–æ–∫–∞—è |

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### ‚úÖ –¢–æ—á–Ω–æ—Å—Ç—å
- LLM **—Å—Ä–∞–∑—É** –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤
- –ù–µ—Ç –ø–æ—Ç–µ—Ä–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –º–µ–∂–¥—É —ç—Ç–∞–ø–∞–º–∏
- –Ø–≤–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞

### ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ CUDA/MPS/CPU
- –ù–∞ Apple Silicon —Ä–∞–±–æ—Ç–∞–µ—Ç **–≤ 6 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ** —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏
- Fallback —Ä–µ–∂–∏–º –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞
- –õ–∏–Ω–µ–π–Ω—ã–π pipeline (3 —à–∞–≥–∞ –≤–º–µ—Å—Ç–æ 4)
- –ü–æ–Ω—è—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
- –õ–µ–≥–∫–æ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å

### ‚úÖ –ì–∏–±–∫–æ—Å—Ç—å
- –ú–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å LLM (`use_llm_parser=False`)
- –õ–µ–≥–∫–æ –∑–∞–º–µ–Ω–∏—Ç—å LLM –º–æ–¥–µ–ª—å
- –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å `top_k` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞

## –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞

```json
{
  "query_id": 1,
  "original_query": "–ö–æ–º–ø–ª–µ–∫—Ç: –∫–æ—Ä–æ–± 200x200, –∫—Ä—ã—à–∫–∞, 4 –≤–∏–Ω—Ç–∞ –ú6",
  "items": [
    {
      "requested_item": "–ö–æ—Ä–æ–± 200x200",
      "quantity": 1,
      "found_product": {
        "id": 3,
        "name": "–ö–æ—Ä–æ–± 200x200 –º–º, L=2000 –º–º, –≥–æ—Ä—è—á–µ–µ —Ü–∏–Ω–∫–æ–≤–∞–Ω–∏–µ...",
        "cost": 88498.0,
        "category": "–ö–æ—Ä–æ–±"
      },
      "relevance_score": 0.9847,
      "unit_price": 88498.0,
      "total_price": 88498.0,
      "specifications": "200x200 –º–º",
      "alternatives": [...]
    },
    {
      "requested_item": "–ö—Ä—ã—à–∫–∞ 200",
      "quantity": 1,
      "unit_price": 45131.0,
      "total_price": 45131.0,
      ...
    },
    {
      "requested_item": "–í–∏–Ω—Ç –ú6",
      "quantity": 4,
      "unit_price": 19047.0,
      "total_price": 76188.0,
      ...
    }
  ],
  "total_items": 3,
  "found_items": 3,
  "total_cost": 209817.0,
  "currency": "RUB"
}
```

## –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏

### –ë—ã–ª–æ (—Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è)

```python
processor = HybridQueryProcessor(
    search_engine=search_engine,
    use_llm=True,
    use_query_enhancement=True,
    use_llm_validator=True,
    use_iterative_search=False
)

result = processor.process_query(
    query=query,
    top_k=10,
    complexity="complex",
    use_validation=True
)
```

### –°—Ç–∞–ª–æ (–Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è)

```python
processor = HybridQueryProcessor(
    search_engine=search_engine,
    use_llm_parser=True,  # LLM –Ω–∞ –≤—Ö–æ–¥–µ
    use_fallback_enhancement=True
)

result = processor.process_query(
    query=query,
    top_k=5  # –ù–∞ –∫–∞–∂–¥—ã–π —Ç–æ–≤–∞—Ä
)
```

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å LLM —Ä–µ–∂–∏–º
- ‚úÖ –°–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Å –∫–æ–º–ø–ª–µ–∫—Ç–∞–º–∏
- ‚úÖ –ó–∞–ø—Ä–æ—Å—ã —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
- ‚úÖ –ï—Å—Ç—å GPU (CUDA/MPS)
- ‚úÖ –ù—É–∂–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Fallback
- ‚úÖ –ü—Ä–æ—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã (1-2 —Ç–æ–≤–∞—Ä–∞)
- ‚úÖ –ù–µ—Ç GPU, —Ç–æ–ª—å–∫–æ CPU
- ‚úÖ –ù—É–∂–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å
- ‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Å–µ–≥–¥–∞ = 1

## –î–∞–ª—å–Ω–µ–π—à–µ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ

### –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ LLM —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤** –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
2. **–ö–≤–∞–Ω—Ç–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏** (4-bit) –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –Ω–∞ CPU
3. **Batch –æ–±—Ä–∞–±–æ—Ç–∫–∞** –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
4. **Fine-tuning Qwen3** –Ω–∞ –Ω–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö
5. **Hybrid —Ä–µ–∂–∏–º**: LLM —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–æ–¥–µ–ª–∏
- **Qwen2.5-7B** - –±–æ–ª—å—à–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –≤—ã—à–µ —Ç–æ—á–Ω–æ—Å—Ç—å
- **Llama-3.1-8B** - —Ö–æ—Ä–æ—à–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞
- **Mistral-7B** - –±—ã—Å—Ç—Ä–µ–µ –Ω–∞ CPU
